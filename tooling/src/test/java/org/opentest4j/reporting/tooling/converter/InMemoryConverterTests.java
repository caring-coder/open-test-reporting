package org.opentest4j.reporting.tooling.converter;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.TempDir;
import org.opentest4j.reporting.events.api.DocumentWriter;
import org.opentest4j.reporting.events.api.NamespaceRegistry;
import org.opentest4j.reporting.events.root.Events;
import org.opentest4j.reporting.schema.Namespace;
import org.xmlunit.assertj3.XmlAssert;

import java.nio.file.Path;
import java.time.Duration;
import java.time.Instant;
import java.util.Map;
import java.util.function.Consumer;

import static org.opentest4j.reporting.events.core.CoreFactory.attachments;
import static org.opentest4j.reporting.events.core.CoreFactory.cpuCores;
import static org.opentest4j.reporting.events.core.CoreFactory.data;
import static org.opentest4j.reporting.events.core.CoreFactory.infrastructure;
import static org.opentest4j.reporting.events.core.CoreFactory.metadata;
import static org.opentest4j.reporting.events.core.CoreFactory.result;
import static org.opentest4j.reporting.events.core.CoreFactory.tag;
import static org.opentest4j.reporting.events.core.CoreFactory.tags;
import static org.opentest4j.reporting.events.core.Result.Status.SUCCESSFUL;
import static org.opentest4j.reporting.events.root.RootFactory.finished;
import static org.opentest4j.reporting.events.root.RootFactory.reported;
import static org.opentest4j.reporting.events.root.RootFactory.started;

class InMemoryConverterTests {

    static final NamespaceRegistry NAMESPACE_REGISTRY = NamespaceRegistry.builder(Namespace.REPORTING_CORE)
            .add("e", Namespace.REPORTING_EVENTS)
            .add("java", Namespace.REPORTING_JAVA)
            .build();

    @TempDir
    Path tempDir;

    @Test
    void convertsInfrastructureSection() throws Exception {
        var sourceFile = tempDir.resolve("events.xml");
        var targetFile = tempDir.resolve("hierarchy.xml");
        writeXml(sourceFile, writer -> writer.append(infrastructure(), infrastructure -> infrastructure.append(cpuCores(42))));

        new InMemoryConverter().convert(sourceFile, targetFile);

        assertThat(targetFile).valueByXPath("//*/c:infrastructure/c:cpuCores").isEqualTo(42);
    }

    @Test
    void convertsStartedAndFinishedEvents() throws Exception {
        var sourceFile = tempDir.resolve("events.xml");
        var targetFile = tempDir.resolve("hierarchy.xml");
        var duration = Duration.ofMillis(42);
        var startTime = Instant.now().minus(duration);
        writeXml(sourceFile, writer -> writer
                .append(started("1", startTime, "container"), started -> started
                        .append(metadata(), metadata -> metadata
                                .append(tags(), tags -> tags
                                        .append(tag("a")))))
                .append(started("2", startTime.plus(duration), "test"), started -> started.withParentId("1"))
                .append(finished("2", startTime.plus(duration.multipliedBy(2))))
                .append(finished("1", startTime.plus(duration.multipliedBy(3))), finished -> finished.append(result(SUCCESSFUL))));

        new InMemoryConverter().convert(sourceFile, targetFile);

        assertThat(targetFile).nodesByXPath("//*/h:root")
                .haveAttribute("name", "container")
                .haveAttribute("start", startTime.toString())
                .haveAttribute("duration", duration.multipliedBy(3).toString());

        assertThat(targetFile).valueByXPath("//*/h:root/c:metadata/c:tags/c:tag").isEqualTo("a");
        assertThat(targetFile).valueByXPath("//*/h:root/c:result/@status").isEqualTo("SUCCESSFUL");

        assertThat(targetFile).nodesByXPath("//*/h:root/h:child")
                .haveAttribute("name", "test")
                .haveAttribute("start", startTime.plus(duration).toString())
                .haveAttribute("duration", duration.toString());
    }

    @Test
    void mergesReportEntries() throws Exception {
        var sourceFile = tempDir.resolve("events.xml");
        var targetFile = tempDir.resolve("hierarchy.xml");
        writeXml(sourceFile, writer -> writer
                .append(started("1", Instant.now(), "test"), started -> started
                        .append(attachments(), attachments -> attachments
                                .append(data(), data -> data.addEntry("started", "1"))))
                .append(reported("1", Instant.now()), reported -> reported
                        .append(attachments(), attachments -> attachments
                                .append(data(), data -> data.addEntry("reported", "2"))))
                .append(finished("1", Instant.now()), finished -> finished
                        .append(attachments(), attachments -> attachments
                                .append(data(), data -> data.addEntry("finished", "3")))));

        new InMemoryConverter().convert(sourceFile, targetFile);

        assertThat(targetFile).nodesByXPath("//*/h:root/c:attachments").hasSize(1);
        assertThat(targetFile).nodesByXPath("//*/h:root/c:attachments/c:data").hasSize(3);
        assertThat(targetFile).valueByXPath("(//*/h:root/c:attachments/c:data/c:entry/@key)[1]").isEqualTo("started");
        assertThat(targetFile).valueByXPath("(//*/h:root/c:attachments/c:data/c:entry/text())[1]").isEqualTo("1");
        assertThat(targetFile).valueByXPath("(//*/h:root/c:attachments/c:data/c:entry/@key)[2]").isEqualTo("reported");
        assertThat(targetFile).valueByXPath("(//*/h:root/c:attachments/c:data/c:entry/text())[2]").isEqualTo("2");
        assertThat(targetFile).valueByXPath("(//*/h:root/c:attachments/c:data/c:entry/@key)[3]").isEqualTo("finished");
        assertThat(targetFile).valueByXPath("(//*/h:root/c:attachments/c:data/c:entry/text())[3]").isEqualTo("3");
    }

    private void writeXml(Path eventsXmlFile, Consumer<DocumentWriter<Events>> action) throws Exception {
        try (var writer = Events.createDocumentWriter(NAMESPACE_REGISTRY, eventsXmlFile)) {
            action.accept(writer);
        }
    }

    private static XmlAssert assertThat(Path targetFile) {
        return XmlAssert.assertThat(targetFile)
                .withNamespaceContext(Map.of(
                        "h", Namespace.REPORTING_HIERARCHY.getUri(),
                        "c", Namespace.REPORTING_CORE.getUri()
                ));
    }
}
